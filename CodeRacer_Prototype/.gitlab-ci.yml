stages:
  - test
  - validate

variables:
  POSTGRES_DB: coderacer_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_URL: postgresql://postgres:postgres@postgres:5432/coderacer_test

# Backend Testing
test:backend:
  stage: test
  image: python:3.11-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: coderacer_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov httpx
  script:
    # Wait for PostgreSQL to be ready
    - apt-get update && apt-get install -y postgresql-client
    - until pg_isready -h postgres -p 5432 -U postgres; do echo "Waiting for postgres..."; sleep 2; done
    # Run tests
    - pytest tests/ --cov=. --cov-report=term-missing --cov-report=xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/coverage.xml
    expire_in: 1 week
  only:
    - main
    - merge_requests
    - develop

# Frontend Testing
test:frontend:
  stage: test
  image: node:20-alpine
  before_script:
    - cd frontend
    - npm install
  script:
    - npm run lint || echo "Linting completed with warnings"
    # Add actual frontend tests when available
    # - npm run test
  cache:
    paths:
      - frontend/node_modules/
  artifacts:
    paths:
      - frontend/node_modules/
    expire_in: 1 day
  only:
    - main
    - merge_requests
    - develop

# Validate Dockerfiles (instead of building)
validate:dockerfiles:
  stage: validate
  image: hadolint/hadolint:latest-alpine
  script:
    - echo "Validating Dockerfile.backend..."
    - hadolint Dockerfile.backend || true
    - echo "Validating Dockerfile.frontend..."
    - hadolint Dockerfile.frontend || true
    - echo "Dockerfile validation complete!"
  only:
    - main
    - merge_requests
    - develop
  needs:
    - test:backend
    - test:frontend
